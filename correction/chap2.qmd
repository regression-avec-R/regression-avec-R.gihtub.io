---
title: "2 La régression linéaire multiple"
toc: true
---

```{r,child='../_preamble.qmd'}
```

::: {#exr-2-1 name="Questions de cours"}
A, A, B, B, B, C.
:::

::: {#exr-2-2 name="Covariance de $\hat\varepsilon$ et $\hat Y$"}
Nous allons montrer que, pour tout autre estimateur $\tilde{\beta}$ de 
$\beta$ linéaire et sans biais, $\V (\tilde{\beta})  \geq \V (\hat \beta)$.
Décomposons la variance de $\tilde{\beta}$
\begin{eqnarray*}
\V (\tilde{\beta})  = \V (\tilde{\beta} - \hat \beta+\hat \beta)
=\V (\tilde{\beta} - \hat \beta)+\V (\hat \beta) -
2 \C(\tilde{\beta} - \hat \beta,\hat \beta).
\end{eqnarray*}
Les variances étant définies positives, si nous montrons que 
$\C(\tilde{\beta}- \hat \beta,\hat \beta)=0$, nous aurons 
fini la démonstration.\\
Puisque $\tilde{\beta}$ est linéaire, $\tilde{\beta} = A Y$. 
De plus, nous savons qu'il est sans biais, c'est-à-dire 
$\E (\tilde{\beta}) = \beta$ pour tout $\beta$, donc $A X = I$. 
La covariance devient :
\begin{eqnarray*}
\C(\tilde{\beta} - \hat \beta,\hat \beta) &=& 
\C(A Y,(X'X)^{-1}X'Y) - \V (\hat \beta)\\
&=& \sigma^2 A X (X'X)^{-1} - \sigma^2 (X'X)^{-1}=0.
\end{eqnarray*}
:::

::: {#exr-2-3 name="Théorème de Gauss Markov"}
Nous devons montrer que, parmi tous les estimateurs linéaires 
sans biais, l'estimateur de MC est celui qui a la plus petite 
variance. La linéarité de $\hat \beta$ est évidente. Calculons sa variance :
\begin{eqnarray*}
\V (\hat \beta) = \V ((X'X)^{-1}X'Y) = 
(X'X)^{-1}X'\V(Y)X(X'X)^{-1}=\sigma^2 (X'X)^{-1}.
\end{eqnarray*}
Nous allons montrer que, pour tout autre estimateur $\tilde{\beta}$ de 
$\beta$ linéaire et sans biais, $\V (\tilde{\beta})  \geq \V (\hat \beta)$.
Décomposons la variance de $\tilde{\beta}$
\begin{eqnarray*}
\V (\tilde{\beta})  = \V (\tilde{\beta} - \hat \beta+\hat \beta)
=\V (\tilde{\beta} - \hat \beta)+\V (\hat \beta) -
2 \C(\tilde{\beta} - \hat \beta,\hat \beta).
\end{eqnarray*}
Les variances étant définies positives, si nous montrons que 
$\C(\tilde{\beta}- \hat \beta,\hat \beta)=0$, nous aurons 
fini la démonstration.\\
Puisque $\tilde{\beta}$ est linéaire, $\tilde{\beta} = A Y$. 
De plus, nous savons qu'il est sans biais, c'est-à-dire 
$\E (\tilde{\beta}) = \beta$ pour tout $\beta$, donc $A X = I$. 
La covariance devient :
\begin{eqnarray*}
\C(\tilde{\beta} - \hat \beta,\hat \beta) &=& 
\C(A Y,(X'X)^{-1}X'Y) - \V (\hat \beta)\\
&=& \sigma^2 A X (X'X)^{-1} - \sigma^2 (X'X)^{-1}=0.
\end{eqnarray*}
:::


::: {#exr-2-4 name="Représentation des variables"}
Nous représentons les données dans $\R^2$ pour le premier 
jeu et dans $\R^3$ pour le second.

![](FIGURES/exo2-4.png){width='75%' fig-align="center"}

Dans le premier modèle, nous projetons $Y$ sur l'espace 
engendré par $X$, soit la droite de vecteur directeur $\overrightarrow{OX}$.
Nous trouvons par le calcul $\hat \beta = 1.47$, résultat 
que nous aurions pu trouver graphiquement car $\overrightarrow{O \hat Y}=
\hat \beta . \overrightarrow{OX}$.

Considérons $\R^3$ muni de la base orthonormée
$(\vec{i},\vec{j},\vec{k})$.  Les vecteurs $\overrightarrow{OX}$ et
$\overrightarrow{OZ}$ engendrent le même plan que celui engendré par
$(\vec{i},\vec{j})$. La projection de $Y$ sur ce plan donne
$\overrightarrow{O \hat Y}$. Il est quasiment impossible de trouver
$\hat \beta$ et $\hat \gamma$ graphiquement mais nous trouvons par le
calcul $\hat \beta = -3.33$ et $\hat \gamma =5$.

:::

::: {#exr-2-5 name="Modèles emboîtés"}
Nous obtenons
\begin{eqnarray*}
\hat Y_p = X \hat \beta \quad  \hbox{et} \quad \hat Y_q= X_q \hat \gamma.
\end{eqnarray*}
Par définition du $\leR$, il faut comparer la norme au carré des
vecteurs $\hat Y_p$ et $\hat Y_q$. Notons les espaces engendrés
par les colonnes de $X_q$ et $X$, $\M_{X_q}$ et $\M_{X}$, nous avons 
$\M_{X_q} \subset  \M_{X}$. Nous obtenons alors 
\begin{eqnarray*}
\hat Y_p = P_{X_p}Y 
= (P_{X_q} + P_{X^{\perp}_q})P_{X_p}Y &=& P_{X_q}P_{X_p}Y + P_{X^{\perp}_q}P_{X_p}Y\\
&=& P_{X_q}Y + P_{X^{\perp}_q \cap X_p} Y\\
&=& \hat Y_q + P_{X^{\perp}_q \cap X_p} Y.
\end{eqnarray*}
En utilisant le théorème de Pythagore, nous avons
\begin{eqnarray*}
\| \hat Y_p \|^2 &=& \|\hat Y_q \|^2 + \| P_{X^{\perp}_q \cap X_p} Y \|^2 
\geq \|\hat Y_q \|^2,
\end{eqnarray*}
d'où
\begin{eqnarray*}
\leR(p)=\frac{\| \hat Y_p \|^2}{\| Y \|^2} \geq
\frac{\| \hat Y_q \|^2}{\| Y \|^2} =\leR(q).
\end{eqnarray*}

En conclusion, lorsque les modèles sont emboîtés $\M_{X_q} \subset  \M_{X}$, 
le $\leR$ du modèle le plus grand (ayant le plus de variables) sera
toujours plus grand que le $\leR$ du modèle le plus petit.
:::

::: {#exr-2-6}
La matrice $X'X$ est symétrique, $n$ vaut 30 et $\bar x= \bar z=0$.
Le coefficient de corrélation
\begin{equation*}
\rho_{x,z} = \frac{\sum_{i=1}^{30} (x_i -\bar x)(z_i - \bar z)}
{\sqrt{\sum_{i=1}^{30} (x_i -\bar x)^2\sum_{i=1}^{30} (z_i - \bar z)^2}}
=\frac{\sum_{i=1}^{30} x_i z_i}
{\sqrt{\sum_{i=1}^{30} x_i^2 \sum_{i=1}^{30} z_i^2}}
=\frac{7}{\sqrt{150}}=0.57.
\end{equation*}
Nous avons 
\begin{eqnarray*}
y_i &=& -2 +x_i+z_i+\hat \varepsilon_i
\end{eqnarray*}
et la moyenne vaut alors
\begin{eqnarray*}
\bar y &=& -2 + \bar x +\bar z + \frac{1}{n}\sum_i \hat \varepsilon_i.
\end{eqnarray*}
La constante étant dans le modèle, la somme des résidus est
nulle car le vecteur $\hat \varepsilon$ est orthogonal au 
vecteur $\1$. Nous obtenons donc que la moyenne de $Y$ vaut 2 
car $\bar x=0$ et $\bar z=0$.
Nous obtenons en développant
\begin{eqnarray*}
\|\hat Y \|^2 &=& \sum_{i=1}^{30}(-2+x_i+2z_i)^2\\
&=& 4+10+60+14=88.
\end{eqnarray*}
Par le théorème de Pythagore, nous concluons que 
\begin{eqnarray*}
\SCT=\SCE+\SCR=88+12=100.
\end{eqnarray*}

:::

::: {#exr-2-7 name="Changement d'échelle des variables explicatives"}
Nous avons l'estimation sur le modèle avec les variables originales qui minimise
\begin{align*}
\MCO(\beta)&=\|Y - \sum_{j=1}^{p} X_j \beta_j \|^{2}
\end{align*}
Cette solution est notée $\hat \beta$.

Nous avons l'estimation sur le modèle avec les variables prémultipliées par $a_{j}$ (changement d'échelle) qui minimise

$$   
\begin{align*}
\tilde{\MCO}(\beta)&=\|Y - \sum_{j=1}^{p} \tilde X_j \beta_j \|^{2} = \|Y - \sum_{j=1}^{p} a_{j} X_j \beta_j \|^{2}\\
&= \|Y - \sum_{j=1}^{p} X_j \gamma_j \|^{2}=\MCO(\gamma),
\end{align*}
$$

en posant en dernière ligne $\gamma_{j}=a_{j} \beta_j$. La solution
de de $\MCO(\gamma)$ (ou encore $\MCO(\beta)$) est $\hat \beta$. La
solution de $\tilde{\MCO}(\beta)$ est alors donnée par
$\hat \beta_{j}=a_{j} \tilde \beta_j$.
:::

::: {#exr-2-8 name="Différence entre régression multiple et régressions simples"}
1.  Calculons l'estimateur des MCO noté traditionnellement $(X'X)^{-1}X'Y$ avec la matrice $X$ qui possède ici deux colonnes (notées ici $X$ et $Z$) et $n$ lignes. On a donc
    \begin{align*}
      (X'X)&=
             \begin{pmatrix}
               \|X\|^{2} & <X,Z>\\
               <X,Z> & \|Z\|^{2} \\
             \end{pmatrix}
    \end{align*}
    Son déterminant est $\Delta= \|X\|^{2}\|Z\|^{2} - 2 <X,Z>$ et son inverse est
    \begin{align*}
      \frac{1}{\Delta}
      \begin{pmatrix}
               \|Z\|^{2} & -<X,Z>\\
               -<X,Z> & \|X\|^{2} \\
      \end{pmatrix}
    \end{align*}
    Ensuite $X'Y$ est simplement le vecteur colonne de coordonnées $<X,Y>$ et  $<Z,Y>$. En rassemblant le tout nous avons
    \begin{align*}
      \hat \beta_{1}&=\frac{1}{\Delta}(\|Z\|^{2} <X,Y> - <X,Z><Z,Y>),\\
      \hat \beta_{2}&=\frac{1}{\Delta}(\|X\|^{2} <Z,Y> - <X,Z><X,Y>).
    \end{align*}
    Si $<X,Z>=0$ (les deux vecteurs sont orthogonaux) alors cette écriture se simplifie en
    $$
      \hat \beta_{1}=\frac{<X,Y>}{\|X\|^{2}},\quad
      \hat \beta_{2}=\frac{<Z,Y>}{\|Z\|^{2}}.
    $$
    
2.  Calculons l'estimateur des MCO noté traditionnellement $(X'X)^{-1}X'Y$ avec la matrice $X$ qui possède ici une colonne (notée ici $X$) et $n$ lignes. On a donc
    \begin{align*}
      \hat \beta_{X} = \frac{<X,Y>}{\|X\|^{2}}.
    \end{align*}
    Passons maintenant à la matrice qui possède ici une colonne (notée ici $Z$) et $n$ lignes. On a donc
    \begin{align*}
      \hat \beta_{Z} = \frac{<Z,Y>}{\|Z\|^{2}}.
    \end{align*}
    
3.  En général les coefficients des régressions simples ne sont pas ceux obtenus par régression multiple sauf si les variables sont orthogonales.

4.  Nous avons ici les résidus de la première régression qui sont
    \begin{align}
      \hat \varepsilon = Y - \hat \beta_{X} X.
    \end{align}
    La deuxième régression (sur les résidus) donne le coefficient
    \begin{align*}
      \hat \beta_{Z} = \frac{<Z,\hat \varepsilon>}{\|Z\|^{2}} = \hat \beta_{Z} - \hat \beta_{X}\frac{<Z,X>}{\|Z\|^{2}}
    \end{align*}
La régression séquentielle donne des coefficients différents des régressions univariées ou bivariées sauf si les variables sont orthogonales.
  \end{enumerate}

:::

::: {#exr-2-9 name="TP : différence entre régression multiple et régressions simples"}
1.  Simulons 2 variables explicatives avec GNU-R pour $n=100$ individus selon selon deux loi uniforme $[0,1]$ :

    ```{r}
    n <- 100
    set.seed(4321) # pour fixer les simulations
    X1 <- runif(n)
    X2 <- runif(n)
    ```

    Ensuite simulons $Y$ selon le modèle avec $\sigma=0.5$

    ```{r}
    sigma <- 0.5
    set.seed(321) # pour fixer les simulations
    Y <- 2 -3*X1 + 4*X2  + rnorm(n, sd=sigma)
    don <- cbind.data.frame(Y,X1,X2)
    head(don)
    ```

2.  Le graphique est obtenu avec

    ```{r,eval=FALSE}
    rgl::plot3d(X1,X2,Y)
    ```

3.  On observe grâce au code ci-dessus que les points sont répartis autour d'un plan (d'équation $z=2-3x + 4y$).

4.  Effectuons la régression multiple et stockons $\hat Y$ dans `Yhat` :

    ```{r}
    (regmult <- lm(Y~1+X1+X2, data=don))
    ```

    Nous sommes assez proches des coefficients recherchés (2, -3 et 4)
5.  Effectuons les régression simples

    ```{r}
    (regX1 <- lm(Y~1+X1, data=don))
    ```

    Nous voyons que le paramètre ne correspond pas à celui de $X_{1}$ dans la régression multiple.

    ```{r}
    (regX2 <- lm(Y~1+X2, data=don))
    ```

    Nous voyons que le paramètre ne correspond pas à celui de $X_{2}$ dans la régression multiple.

6.  Enchainons après la régression simple sur $X_{1}$ la régression des résidus (ce que $X_{1}$ n'a pas réussi à modéliser) sur $X_{2}$:

    ```{r}
    residX1 <- residuals(regX1)
    don <- cbind(don, residX1)
    regX2residX1 <- lm(residX1~1+X2, data=don)
    regX2residX1
    ```
    
    Là encore le coefficient sur $X_{2}$ ne correspond pas à celui de $X_{2}$  dans la régression multiple. :La prévision est différente

    ```{r}
    (predict(regX2residX1) + predict(regX1))[1:5]
    ```

6.  Changeons l'ordre

    ```{r}
    residX2 <- residuals(regX2)
    don <- cbind(don, residX2)
    regX1residX2 <- lm(residX2~1+X1, data=don)
    regX1residX2
    ```

    On a là encore des différences
    
    ```{r}
    (predict(regX1residX2) + predict(regX2))[1:5]
    ```
    
7.  Envisageons la covariance empirique

    ```{r}
    cov(X1,X2)    
    ```
    
    et leur produit scalaire
    
    ```{r}
    sum(X1*X2)
    ```
   
    Les deux variables sont loin d'être orthogonales. Centrons les

    ```{r}
    X1c <- X1 - mean(X1)
    X2c <- X2 - mean(X2)
    sum(X1c*X2c) 
    ```
    
    Refaisons les régressions: la multiple

    ```{r}
    donc <- cbind.data.frame(Y,X1c,X2c)
    (regmultc <- lm(Y~1+X1c+X2c, data=donc))
    ```

    Nous retrouvons que seul la constante change puis l'enchainement

    ```{r}
    (regX1c <- lm(Y~1+X1c, data=donc))
    ```
    
    Ici les variables $X_{1c}$ et $X_{2c}$ étant centrées elles sont orthogonales à la constante. Nous avons donc
        \begin{align}
          \Im(\un, X_{1c}, X_{2c}) = \Im(\un) \stackrel{\perp}{\oplus} \Im(X_{1c}, X_{2c})
        \end{align}
    Le modèle précédent nous donne grâce à l'orthogonalité ci-dessus $\hat Y_{1c} = P_{\un, X_{1c}}Y=P_{\un}Y + P_{X_{1c}}Y$. Le modèle complet donne de son côté $\hat Y = P_{\un, X_{1c},X_{2c}}Y=P_{\un}Y + P_{X_{1c},X_{2c}}Y$. Nous retrouvons donc le coefficient constant qui est la coordonnée sur $\un$ de $P_{\un}Y$ dans les deux cas.
      
        
    Enchainons sur la régression sur résidus

    ```{r}
    residX1c <- residuals(regX1c)
    donc <- cbind(donc, residX1c)
    (regX2residX1c <- lm(residX1c~1+X2c, data=don))
    ```

    Puisque le vecteur \code{residX1c} est $Y- \hat Y_{1}=Y-P_{\un}Y-P_{X_{1c}}Y$ et que $X_{2c}\perp\un$ on a la projection des résidus sur $\Im(\un, X_{2c})$ qui vaut
    \begin{align*}
      P_{\un, X_{2c}}(Y- \hat Y_{1c})&= P_{\un}(Y- \hat Y_{1c}) + P_{X_{2c}}(Y- \hat Y_{1c})\\
      &=P_{\un}Y - P_{\un}P_{\un, X_{1c}}Y + P_{X_{2c}}Y -  P_{X_{2c}}P_{\un, X_{1c}}Y\\
      &= P_{\un}Y - P_{\un}Y - 0 + P_{X_{2c}}Y - 0 - P_{X_{2c}}P_{X_{1c}}Y\\
      &= P_{X_{2c}} Y - P_{X_{2c}}P_{X_{1c}}Y
    \end{align*}
    Cette dernière somme de projection est dans $\Im(X_{1c}, X_{2c})$ qui est un sous-espace orthogonal à $\Im(\un)$, d'où le coefficient 0 pour la constante.

    Pour les prévisions rien ne change :
    
    ```{r}
    predict(regmultc)[1:5]
    ```
    


:::


::: {#exr-2-10 name="TP : régression multiple et code R"}

1.  

    ```{r}
    ozone <- read.table("../donnees/ozone_complet.txt",sep=";",header=TRUE)
    nomvar <- names(ozone)
    ```

2.  

    ```{r}
    (ch <- paste(nomvar[-1],collapse = "+"))
    ```

3.  

    ```{r}
    (ch2 <- paste("maxO3~",ch,sep=""))
    ```

4.  

    ```{r}
    form <- formula(ch2)
    lm(form,data=ozone)
    ```

:::

::: {#exr-2-11 name="Régression orthogonale"}
Les vecteurs étant orthogonaux, nous avons 
$\M_X = \M_U \stackrel{\perp}{\oplus} \M_V$. Nous pouvons 
alors écrire
\begin{eqnarray*}
\hat Y_X = P_X Y &=& (P_U + P_{U^{\perp}})P_X Y \\
&=& P_U P_X Y + P_{U^{\perp}}P_X Y =  P_U Y + P_{U^{\perp}\cap X} Y \\
&=& \hat Y_U + \hat Y_V.
\end{eqnarray*}
La suite de l'exercice est identique. En conclusion, effectuer une régression 
multiple sur des variables orthogonales revient à effectuer $p$ 
régressions simples.
:::

::: {#exr-2-12 name="Centrage, centrage-réduction et coefficient constant"}
1.  Comme la dernière colonne de $X$, notée $X_p$ vaut $\un_n$ sa moyenne empirique vaut $1$ et la variable centrée issue de $X_p$ est donc $X_p -1\times\un_n=\boldsymbol{0}_n$.

2.  Nous avons le modèle sur variable centrée
\begin{eqnarray*}
\tilde Y&=&\tilde X\tilde \beta+ \varepsilon\\
Y-\bar Y\un_n&=&\sum_{j=1}^{p-1}{(X_j -\bar X_j\un_n)\tilde\beta_j}+\varepsilon\\
Y&=&\sum_{j=1}^{p-1}{\tilde\beta_j X_j}+ \Bigl(\bar Y -\sum_{j=1}^{p-1}{\bar X_j\tilde\beta_j}\Bigr)\un_n+\varepsilon.
\end{eqnarray*}
En identifiant cela donne
$$
\begin{eqnarray}
\beta_j&=&\tilde\beta_j,\ \forall j\in\{1,\dotsc,p-1\},\nonumber\\
\beta_p&=&\bar Y\un_n-\sum_{j=1}^{p-1}{\bar X_j\tilde\beta_j}.
\end{eqnarray}
$${#eq-coefct}
Si l'on utilise des variables centrées dans le modèle de régression,
on ne met pas de colonne $\un$ (pas de coefficient constant -
*intercept*). Les coefficients du modèle sur les variables
originales sont égaux à ceux sur les variables centrées et le
coefficient constant est donné par la formule (@eq-coefct}).

3.  Maintenant les variables explicatives sont centrées et réduites~:
\begin{eqnarray*}
\tilde Y&=&\tilde X\tilde \beta+ \varepsilon\\
Y-\bar Y\un_n&=&\sum_{j=1}^{p-1}{\frac{(X_j -\bar X_j\un_n)}{\hat\sigma_{X_j}}\tilde\beta_j}+\varepsilon\\
Y&=&\sum_{j=1}^{p-1}{\frac{\tilde\beta_j}{\hat\sigma_{X_j}}X_j}+ \Bigl(\bar Y-\sum_{j=1}^{p-1}{\bar X_j\frac{\tilde\beta_j}{\hat\sigma_{X_j}}}\Bigr)\un_n+\varepsilon.
\end{eqnarray*}
En identifiant cela donne
\begin{eqnarray*}
\beta_j&=&\frac{\tilde\beta_j}{\hat\sigma_{X_j}},\ \forall j\in\{1,\dotsc,p-1\},\\
\beta_p&=&\bar Y\un_n-\sum_{j=1}^{p-1}{\bar X_j\frac{\tilde\beta_j}{\hat\sigma_{X_j}}}.
\end{eqnarray*}
    Nous obtenons ici que les coefficients du modèle sur les
variables originales sont égaux à ceux sur les variables centrées-réduites divisés par l'écart-type empirique des variables explicatives. Plus la variable explicative $X_j$ est dispersée, plus son coefficient $\beta_j$ sera réduit par rapport à $\tilde\beta_j$. Le coefficient constant est donné par la formule ci-dessus.

4.  La variable à expliquer $Y$ est elle aussi centrée-réduite~:
\begin{eqnarray*}
\tilde Y&=&\tilde X\tilde \beta+ \tilde\varepsilon\\
\frac{Y-\bar Y\un_n}{\hat\sigma_Y}&=&\sum_{j=1}^{p-1}{\frac{(X_j -\bar X_j\un_n)}{\hat\sigma_{X_j}}\tilde\beta_j}+\tilde\varepsilon\\
Y&=&\hat\sigma_Y\sum_{j=1}^{p-1}{\frac{\tilde\beta_j}{\hat\sigma_{X_j}}X_j}+ \Bigl(\bar Y-\hat\sigma_Y\sum_{j=1}^{p-1}{\bar X_j\frac{\tilde\beta_j}{\hat\sigma_{X_j}}}\Bigr)\un_n+\hat\sigma_Y\tilde\varepsilon.
\end{eqnarray*}
    En identifiant cela donne
\begin{eqnarray*}
\beta_j&=&\hat\sigma_Y\frac{\tilde\beta_j}{\hat\sigma_{X_j}},\ \forall j\in\{1,\dotsc,p-1\},\\
\beta_p&=&\bar Y\un_n-\hat\sigma_Y\sum_{j=1}^{p-1}{\bar X_j\frac{\tilde\beta_j}{\hat\sigma_{X_j}}},\\
\varepsilon&=&\hat\sigma_Y\tilde\varepsilon.
\end{eqnarray*}
    L'écart-type empirique de $Y$ entre en jeu et nous constatons que les
résidus du modèle \og centré-réduit\fg~ sont égaux à ceux initiaux divisés
par l'écart-type empirique de $Y$.

:::

::: {#exr-2-13 name="Moindres carrés contraints"}

:::

