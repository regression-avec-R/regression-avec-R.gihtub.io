{
  "hash": "fe6a7743553399d2fd1acbd2ae133dee",
  "result": {
    "markdown": "---\ntitle: \"11 Régression logistique\"\ntoc: true\n---\n\n\n# Présentation du modèle\n\n\n::: {.cell}\n\n```{.r .cell-code}\nartere <- read.table(\"../donnees/artere.txt\",header=T)\nplot(chd~age,data=artere,pch=16)\n```\n\n::: {.cell-output-display}\n![](chap11_files/figure-html/unnamed-chunk-1-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ntab_freq <- table(artere$agrp,artere$chd)\nfreq <- tab_freq[,2]/apply(tab_freq,1,sum)\ncbind(tab_freq,round(freq,3))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n   0  1      \n1  9  1 0.100\n2 13  2 0.133\n3  9  3 0.250\n4 10  5 0.333\n5  7  6 0.462\n6  3  5 0.625\n7  4 13 0.765\n8  2  8 0.800\n```\n:::\n\n```{.r .cell-code}\nx.age <- c(19,29,34,39,44,49,54,59)\nplot(x.age,c(freq),type=\"s\",xlim=c(18,80),ylim=c(0,1),xlab=\"âge\",ylab=\"freq\")\nlines(c(59,80),rep(freq[length(freq)],2))\nx <- seq(15,80,by=0.01)\ny <- exp(-5.31+0.11*x)/(1+exp(-5.31+0.11*x))\nlines(x,y,lty=3)\n```\n\n::: {.cell-output-display}\n![](chap11_files/figure-html/unnamed-chunk-2-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nglm(chd~age,data=artere,family=binomial)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nCall:  glm(formula = chd ~ age, family = binomial, data = artere)\n\nCoefficients:\n(Intercept)          age  \n    -5.3095       0.1109  \n\nDegrees of Freedom: 99 Total (i.e. Null);  98 Residual\nNull Deviance:\t    136.7 \nResidual Deviance: 107.4 \tAIC: 111.4\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(12345)\nX <- factor(sample(c(\"A\",\"B\",\"C\"),100,replace=T))\n#levels(X) <- c(\"A\",\"B\",\"C\")\nY <- rep(0,100)\nY[X==\"A\"] <- rbinom(sum(X==\"A\"),1,0.9)\nY[X==\"B\"] <- rbinom(sum(X==\"B\"),1,0.1)\nY[X==\"C\"] <- rbinom(sum(X==\"C\"),1,0.9)\ndonnees <- data.frame(X,Y)\nmodel <- glm(Y~.,data=donnees,family=binomial)\ncoef(model)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n(Intercept)          XB          XC \n  2.0794415  -3.6549779   0.3772942 \n```\n:::\n\n```{.r .cell-code}\nmodel1 <- glm(Y~C(X,sum),data=donnees,family=binomial)\ncoef(model1)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n(Intercept)  C(X, sum)1  C(X, sum)2 \n  0.9868803   1.0925612  -2.5624167 \n```\n:::\n:::\n\n\n# Intervalles de confiance et tests\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(bestglm)\ndata(SAheart)\nnew.SAheart <- SAheart[c(2,408,35),]\nrow.names(new.SAheart) <- NULL\nSAheart <- SAheart[-c(2,408,35),]\nmodel <- glm(chd~.,data=SAheart,family=binomial)\nround(summary(model)$coefficients,4)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n               Estimate Std. Error z value Pr(>|z|)\n(Intercept)     -6.0837     1.3141 -4.6294   0.0000\nsbp              0.0065     0.0058  1.1268   0.2598\ntobacco          0.0814     0.0269  3.0232   0.0025\nldl              0.1794     0.0600  2.9891   0.0028\nadiposity        0.0184     0.0295  0.6224   0.5337\nfamhistPresent   0.9325     0.2291  4.0694   0.0000\ntypea            0.0392     0.0123  3.1845   0.0015\nobesity         -0.0637     0.0446 -1.4300   0.1527\nalcohol          0.0002     0.0045  0.0346   0.9724\nage              0.0439     0.0122  3.5923   0.0003\n```\n:::\n\n```{.r .cell-code}\nconfint.default(model)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n                      2.5 %       97.5 %\n(Intercept)    -8.659355064 -3.507983650\nsbp            -0.004797560  0.017773140\ntobacco         0.028628110  0.134174033\nldl             0.061770934  0.297043348\nadiposity      -0.039461469  0.076187468\nfamhistPresent  0.483354369  1.381572764\ntypea           0.015090098  0.063396115\nobesity        -0.151054913  0.023612482\nalcohol        -0.008639577  0.008950096\nage             0.019931097  0.067793230\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nn <- 1000\nset.seed(123)\nX1 <- sample(c(\"A\",\"B\",\"C\"),n,replace=TRUE)\nX2 <- rnorm(n)\nX3 <- runif(n)\ncl <- 1+0*(X1==\"A\")+1*(X1==\"B\")-3*(X1==\"C\")+2*X2\nY <- rbinom(n,1,exp(cl)/(1+exp(cl)))\ndonnees <- data.frame(X1,X2,X3,Y)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nm1 <- glm(Y~.,data=donnees,family=binomial)\nlibrary(car)\nAnova(m1,type=3,test.statistic=\"Wald\")\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nAnalysis of Deviance Table (Type III tests)\n\nResponse: Y\n            Df    Chisq Pr(>Chisq)    \n(Intercept)  1  28.4698  9.517e-08 ***\nX1           2 212.5061  < 2.2e-16 ***\nX2           1 210.3902  < 2.2e-16 ***\nX3           1   0.3096     0.5779    \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n:::\n\n```{.r .cell-code}\nAnova(m1,type=3,test.statistic=\"LR\")\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nAnalysis of Deviance Table (Type III tests)\n\nResponse: Y\n   LR Chisq Df Pr(>Chisq)    \nX1   376.74  2     <2e-16 ***\nX2   417.66  1     <2e-16 ***\nX3     0.31  1     0.5778    \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n:::\n\n```{.r .cell-code}\nm01 <- glm(Y~X2+X3,data=donnees,family=binomial)\nm02 <- glm(Y~X1+X3,data=donnees,family=binomial)\nm03 <- glm(Y~X1+X2,data=donnees,family=binomial)\nanova(m01,m1,test=\"LRT\")\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nAnalysis of Deviance Table\n\nModel 1: Y ~ X2 + X3\nModel 2: Y ~ X1 + X2 + X3\n  Resid. Df Resid. Dev Df Deviance  Pr(>Chi)    \n1       997    1109.67                          \n2       995     732.93  2   376.74 < 2.2e-16 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n:::\n\n```{.r .cell-code}\nanova(m02,m1,test=\"LRT\")\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nAnalysis of Deviance Table\n\nModel 1: Y ~ X1 + X3\nModel 2: Y ~ X1 + X2 + X3\n  Resid. Df Resid. Dev Df Deviance  Pr(>Chi)    \n1       996    1150.59                          \n2       995     732.93  1   417.66 < 2.2e-16 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n:::\n\n```{.r .cell-code}\nanova(m03,m1,test=\"LRT\")\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nAnalysis of Deviance Table\n\nModel 1: Y ~ X1 + X2\nModel 2: Y ~ X1 + X2 + X3\n  Resid. Df Resid. Dev Df Deviance Pr(>Chi)\n1       996     733.24                     \n2       995     732.93  1  0.30976   0.5778\n```\n:::\n\n```{.r .cell-code}\nlibrary(aod)\nwald.test(Sigma=vcov(m1),b=coef(m1),Terms=c(2,3))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nWald test:\n----------\n\nChi-squared test:\nX2 = 212.5, df = 2, P(> X2) = 0.0\n```\n:::\n:::\n\n\n\n# Prévisions\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmodel <- glm(chd~.,data=SAheart,family=binomial)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nnew.SAheart <- SAheart[c(2,408,35),-10]\nrow.names(new.SAheart) <- NULL\nnew.SAheart\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n  sbp tobacco  ldl adiposity famhist typea obesity alcohol age\n1 118    0.08 3.48     32.28 Present    52   29.14    3.81  46\n2 178   20.00 9.78     33.55  Absent    37   27.29    2.88  62\n3 140    3.90 7.32     25.05  Absent    47   27.36   36.77  32\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\npredict(model, newdata=new.SAheart)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n         1          2          3 \n-0.9599837  1.5028033 -1.5743496 \n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\npredict(model, newdata=new.SAheart,type=\"response\")\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n        1         2         3 \n0.2768815 0.8179922 0.1715972 \n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nprev <- predict(model,newdata=new.SAheart,type=\"link\",se.fit = TRUE)\ncl_inf <- prev$fit-qnorm(0.975)*prev$se.fit\ncl_sup <- prev$fit+qnorm(0.975)*prev$se.fit\nbinf <- exp(cl_inf)/(1+exp(cl_inf))\nbsup <- exp(cl_sup)/(1+exp(cl_sup))\ndata.frame(binf,bsup)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n       binf      bsup\n1 0.1774323 0.4046504\n2 0.6040315 0.9297800\n3 0.1024782 0.2731474\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nunique(artere[,\"age\"])\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n [1] 20 23 24 25 26 28 29 30 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48\n[26] 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 69\n```\n:::\n\n```{.r .cell-code}\nsature <- aggregate(artere[,\"chd\"],by=list(artere$age),FUN=mean)\nnames(sature) <- c(\"age\",\"p\")\nndesign <- aggregate(artere[,\"chd\"],by=list(artere$age),FUN=length)\nnames(ndesign) <- c(\"age\",\"n\")\nmerge(sature,ndesign,by=\"age\")[1:5,]\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n  age   p n\n1  20 0.0 1\n2  23 0.0 1\n3  24 0.0 1\n4  25 0.5 2\n5  26 0.0 2\n```\n:::\n\n```{.r .cell-code}\nplot(chd~age,data=artere,pch=15+chd,col=chd+1)\nlines(p~age,data=sature)\n```\n\n::: {.cell-output-display}\n![](chap11_files/figure-html/unnamed-chunk-13-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nmodel <- glm(chd~.,data=SAheart,family=binomial)\nlibrary(generalhoslem)\nlogitgof(obs= SAheart$chd, exp = fitted(model))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\n\tHosmer and Lemeshow test (binary model)\n\ndata:  SAheart$chd, fitted(model)\nX-squared = 6.6586, df = 8, p-value = 0.5739\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nmodel <- glm(chd~.,data=SAheart,family=binomial)\nprev_lin <- predict(model)\nres_P <- residuals(model,type=\"pearson\") #Pearson\nres_PS <- rstandard(model,type=\"pearson\") #Pearson standard\nres_D <- residuals(model,type=\"deviance\")  #Deviance\nres_DS <- rstandard(model,type=\"deviance\") #Deviance standard\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\npar(mfrow=c(2,2),pch=20,mai = c(0.1,0.15,0.1,0.1),mar=c(3,3,1,1),cex.axis=0.6,cex.lab=0.7,mgp=c(1.5,0.3,0),oma=c(1,0,0,0),tcl=-0.4)\nplot(res_PS,cex=0.3,xlab=\"index\",ylab=\"Pearson Standard\")\nplot(prev_lin,cex=0.3,res_PS,xlab=\"Prevision lineaire\",ylab=\"Pearson Standard\")\nplot(res_DS,cex=0.3,xlab=\"index\",ylab=\"Deviance Standard\")\nplot(prev_lin,cex=0.3,res_DS,xlab=\"Prevision lineaire\",ylab=\"Deviance Standard\")\n```\n\n::: {.cell-output-display}\n![](chap11_files/figure-html/unnamed-chunk-16-1.png){width=672}\n:::\n:::\n\n\n\n# Choix de variables\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmodel0 <- glm(chd~sbp+ldl,data=SAheart,family=binomial)\nmodel1 <- glm(chd~sbp+ldl+famhist+alcohol,data=SAheart,family=binomial)\nanova(model0,model1,test=\"LRT\")\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nAnalysis of Deviance Table\n\nModel 1: chd ~ sbp + ldl\nModel 2: chd ~ sbp + ldl + famhist + alcohol\n  Resid. Df Resid. Dev Df Deviance  Pr(>Chi)    \n1       456     548.18                          \n2       454     522.64  2   25.545 2.838e-06 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndata(SAheart)\nmod_sel <- bestglm(SAheart,family=binomial,IC=\"BIC\")\nmod_sel$BestModels\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n    sbp tobacco   ldl adiposity famhist typea obesity alcohol  age Criterion\n1 FALSE    TRUE  TRUE     FALSE    TRUE  TRUE   FALSE   FALSE TRUE  506.3634\n2 FALSE    TRUE FALSE     FALSE    TRUE  TRUE   FALSE   FALSE TRUE  509.2566\n3 FALSE    TRUE  TRUE     FALSE    TRUE FALSE   FALSE   FALSE TRUE  509.9861\n4 FALSE   FALSE  TRUE     FALSE    TRUE  TRUE   FALSE   FALSE TRUE  510.5745\n5 FALSE    TRUE  TRUE     FALSE    TRUE  TRUE    TRUE   FALSE TRUE  510.7933\n```\n:::\n\n```{.r .cell-code}\nmod_sel1 <- bestglm(SAheart,family=binomial,IC=\"AIC\")\nmod_sel1$BestModels\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n    sbp tobacco  ldl adiposity famhist typea obesity alcohol  age Criterion\n1 FALSE    TRUE TRUE     FALSE    TRUE  TRUE   FALSE   FALSE TRUE  485.6856\n2 FALSE    TRUE TRUE     FALSE    TRUE  TRUE    TRUE   FALSE TRUE  485.9799\n3  TRUE    TRUE TRUE     FALSE    TRUE  TRUE    TRUE   FALSE TRUE  486.5490\n4  TRUE    TRUE TRUE     FALSE    TRUE  TRUE   FALSE   FALSE TRUE  486.6548\n5 FALSE    TRUE TRUE      TRUE    TRUE  TRUE   FALSE   FALSE TRUE  487.4435\n```\n:::\n:::\n\n\n\n\n# Scoring\n\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(1234)\nind.app <- sample(nrow(SAheart),300)\ndapp <- SAheart[ind.app,]\ndval <- SAheart[-ind.app,]\n#Construction des modeles\nmodel1 <- glm(chd~tobacco+famhist,data=dapp,family=binomial)\nmodel2 <- glm(chd~tobacco+famhist+adiposity+alcohol,\n                data=dapp,family=binomial)  \nround(coef(model1),3)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n   (Intercept)        tobacco famhistPresent \n        -1.784          0.140          1.095 \n```\n:::\n\n```{.r .cell-code}\nround(coef(model2),3)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n   (Intercept)        tobacco famhistPresent      adiposity        alcohol \n        -3.180          0.117          1.022          0.059         -0.002 \n```\n:::\n\n```{.r .cell-code}\nprev1 <- round(predict(model1,newdata=dval,type=\"response\"))\nprev2 <- round(predict(model2,newdata=dval,type=\"response\"))\nmean(prev1!=dval$chd)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 0.3395062\n```\n:::\n\n```{.r .cell-code}\nmean(prev2!=dval$chd)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 0.3395062\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(1245)\nbloc <- sample(1:10,nrow(SAheart),replace=TRUE)\ntable(bloc)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nbloc\n 1  2  3  4  5  6  7  8  9 10 \n52 39 44 62 49 36 47 38 53 42 \n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nprev <- data.frame(matrix(0,nrow=nrow(SAheart),ncol=2))\nnames(prev) <- c(\"model1\",\"model2\")\nfor (k in 1:10){\n  ind.val <- bloc==k\n  dapp.k <- SAheart[!ind.val,]\n  dval.k <- SAheart[ind.val,]\n  model1 <- glm(chd~tobacco+famhist,data=dapp.k,family=binomial)\n  model2 <- glm(chd~tobacco+famhist+adiposity+alcohol,data=dapp.k,family=binomial)  \n  prev[ind.val,1] <- round(predict(model1,newdata=dval.k,type=\"response\"))\n  prev[ind.val,2] <- round(predict(model2,newdata=dval.k,type=\"response\"))\n}\napply(sweep(prev,1,SAheart$chd,FUN=\"!=\"),2,mean)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n   model1    model2 \n0.3203463 0.3073593 \n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nscore1 <- predict(model1,newdata=dval)\nscore2 <- predict(model2,newdata=dval)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(pROC)\nR1 <- roc(dval$chd,score1)\nR2 <- roc(dval$chd,score2)\nplot(R1,lwd=3,legacy.axes=TRUE)\nplot(R2,lwd=3,col=\"red\",lty=2,legacy.axes=TRUE,add=TRUE)\ncouleur <- c(\"black\",\"red\")\nlegend(\"bottomright\",legend=c(\"score1\",\"score2\"),col=couleur,lty=1:2,lwd=2,cex=0.75)\n```\n\n::: {.cell-output-display}\n![](chap11_files/figure-html/unnamed-chunk-23-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nauc(R1)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nArea under the curve: 0.7356\n```\n:::\n\n```{.r .cell-code}\nauc(R2)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nArea under the curve: 0.7372\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nscore <- data.frame(matrix(0,nrow=nrow(SAheart),ncol=2))\nnames(score) <- c(\"score1\",\"score2\")\nfor (k in 1:10){\n  ind.val <- bloc==k\n  dapp.k <- SAheart[!ind.val,]\n  dval.k <- SAheart[ind.val,]\n  model1 <- glm(chd~tobacco+famhist,data=dapp.k,family=binomial)\n  model2 <- glm(chd~tobacco+famhist+adiposity+alcohol,data=dapp.k,family=binomial)  \n  score[ind.val,1] <- predict(model1,newdata=dval.k)\n  score[ind.val,2] <- predict(model2,newdata=dval.k)\n}\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nscore$obs <- SAheart$chd\nroc.cv <- roc(obs~score1+score2,data=score)\ncouleur <- c(\"black\",\"red\")\nmapply(plot,roc.cv,col=couleur,lty=1:2,add=c(F,T),lwd=3,legacy.axes=TRUE)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n                   score1      score2     \npercent            FALSE       FALSE      \nsensitivities      numeric,356 numeric,463\nspecificities      numeric,356 numeric,463\nthresholds         numeric,356 numeric,463\ndirection          \"<\"         \"<\"        \ncases              numeric,160 numeric,160\ncontrols           numeric,302 numeric,302\nfun.sesp           ?           ?          \nauc                0.7159872   0.7271937  \ncall               expression  expression \noriginal.predictor numeric,462 numeric,462\noriginal.response  integer,462 integer,462\npredictor          numeric,462 numeric,462\nresponse           integer,462 integer,462\nlevels             character,2 character,2\npredictor.name     \"score1\"    \"score2\"   \nresponse.name      \"obs\"       \"obs\"      \n```\n:::\n\n```{.r .cell-code}\nlegend(\"bottomright\",legend=c(\"score1\",\"score2\"),col=couleur,lty=1:2,lwd=2,cex=0.75)\n```\n\n::: {.cell-output-display}\n![](chap11_files/figure-html/unnamed-chunk-26-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nsort(round(unlist(lapply(roc.cv,auc)),3),decreasing=TRUE)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nscore2 score1 \n 0.727  0.716 \n```\n:::\n:::\n",
    "supporting": [
      "chap11_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}